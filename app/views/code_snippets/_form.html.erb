<% content_for :head_stuff do %>
<%= stylesheet_link_tag "jquery/themes/base/jquery.ui.all" %>
<%= javascript_include_tag "jquery/jquery-1.6.2" %>
<%
    ['core', 'widget', 'mouse', 'draggable', 'resizable', 'position', 'autocomplete', 'button', 'dialog'].each do |file|
        %><%= javascript_include_tag "jquery/ui/jquery.ui.#{file}" %><%
    end
%>

<%= stylesheet_link_tag "codemirror/codemirror" %>
<%
    ['default', 'elegant', 'neat', 'night'].each do |theme|
        %><%= stylesheet_link_tag "codemirror/theme/#{theme}" %><%
    end
%>

<%= javascript_include_tag "codemirror/lib/codemirror" %>
<%
    ['clike', 'haskell', 'javascript', 'lua', 'perl', 'php', 'python', 'ruby', 'scheme', 'smalltalk'].each do |mode|
        %><%= javascript_include_tag "codemirror/mode/#{mode}/#{mode}" %><%
    end
%>

<%= javascript_include_tag "combobox" %>
<%= javascript_include_tag "service" %>

<%
    @menu_items = ['new', 'open', 'save']
%>

<!-- jQuery styles -->
<style type="text/css">
    .ui-button { margin-left: -1px; }
    .ui-button-icon-only .ui-button-text { padding: 0.35em; } 
    .ui-autocomplete-input { margin-right: 0; padding: 0.48em 0 0.47em 0.45em; }
</style>

<!-- CodeMirror styles -->
<style type="text/css">
    .CodeMirror {
        border: 1px solid #eee;
    }
    .CodeMirror-scroll {
        font-family: Consolas, Inconsolata, monospace;
        height: auto;
        min-height: 300px;
        overflow-y: hidden;
        overflow-x: auto;
    }
</style>

<script type="text/javascript"><!--
    function onCompiling() {
        $("#console-info").removeClass("error");
        $("#console-info").text("");
        $("#console-output").text("");
        $("#console-loading-container").show();
        $("#console-container").hide();
    }

    function onCompiled() {
        $("#console-loading-container").hide();
        $("#console-container").show();
    }

    $(document).ready(function() {
        var modeMap = {
            c: "text/x-csrc",
            cpp: "text/x-c++src",
            cs: "text/x-csharp",
            haskell: "text/x-haskell",
            java: "text/x-java",
            javascript: "text/javascript",
            lua: "text/x-lua",
            perl: "text/x-perl",
            php: "text/x-php",
            python: "text/x-python",
            ruby: "text/x-ruby",
            scheme: "text/x-scheme",
            smalltalk: "text/x-stsrc"
        };

        var codeEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            lineNumbers: true
        });
        
        var languageSelect = $("#language-select").combobox();
        languageSelect.bind("comboboxupdate", function() {
            var selectedLanguage = languageSelect.find("option:selected").val();
            codeEditor.setOption("mode", modeMap[selectedLanguage]);
        });

        var themeSelect = $("#theme-select").combobox();
        themeSelect.bind("comboboxupdate", function() {
            var selectedTheme = themeSelect.find("option:selected").val();
            codeEditor.setOption("theme", selectedTheme);
        });
        
        var compileButton = $("#compile-button").button();
        compileButton.click(function() {
            var code = codeEditor.getValue(),
                language = languageSelect.val();

            onCompiling();
            $("#console-dialog").dialog("open");

            ideoneService.execute(code, language)
                .onSuccess(function(data) {
                    onCompiled();
                    if (data.isError) {
                        $("#console-info").addClass("error");
                    }
                    $("#console-info").text(data.info);
                    $("#console-output").text(data.output);
                })
                .onError(function(data) {
                    onCompiled();
                    $("#console-output").text(JSON.stringify(data));
                });
        });
        
        var consoleDialog = $("#console-dialog").dialog({
            autoOpen: false,
            modal: true,
            height: 480,
            width: 640,
            dialogClass: "console",
            buttons: {
                Close: function() {
                    $(this).dialog("close");
                }
            }
        });

        <% unless @code_snippet.nil? || @code_snippet.language.nil? %>
        languageSelect.val("<%= @code_snippet.language %>");
        languageSelect.combobox("refresh");
        <% end %>
    });
--></script>
<% end %>

<form>
    <div id="toolbar-area">
        <label for="language-select">Language</label>
        <select name="language-select" id="language-select">
            <option value="c">C</option>
            <option value="cpp">C++</option>
            <option value="cs">C#</option>
            <option value="haskell">Haskell</option>
            <option value="java">Java</option>
            <option value="javascript">JavaScript</option>
            <option value="lua">Lua</option>
            <option value="perl">Perl</option>
            <option value="php">PHP</option>
            <option value="python">Python</option>
            <option value="ruby">Ruby</option>
            <option value="scheme">Scheme</option>
            <option value="smalltalk">Smalltalk</option>
        </select>
        
        <label for="theme-select">Theme</label>
        <select name="theme-select" id="theme-select">
            <option value="default" selected="selected">Default</option>
            <option value="night">Night</option>
            <option value="neat">Neat</option>
            <option value="elegant">Elegant</option>
        </select>
    </div>

    <textarea name="code-editor" id="code-editor"><%= @code_snippet ? @code_snippet.snippet : "" %></textarea>
</form>

<div id="button-area">
    <button name="compile-button" id="compile-button">Compile</button>
</div>

<% content_for :foot_stuff do %>
<div id="console-dialog" title="Console">
    <div id="console-loading-container">
        <div id="console-loading">
            <%= image_tag("loading.gif") %><br />
            Compiling...
        </div>
    </div>
    <div id="console-container">
        <div id="console-info"></div>
        <pre id="console-output"></pre>
    </div>
</div>
<% end %>